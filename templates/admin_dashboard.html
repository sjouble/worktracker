{% extends "base.html" %}

{% block title %}ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - ë‹¤ì´ì†Œ ì•ˆì„±ì„¼í„°{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
                <p class="text-muted">ì˜¤ëŠ˜ ë“±ë¡ëœ ì „ì²´ ì‚¬ìš©ìì˜ ì—…ë¬´ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('admin_users') }}" class="btn btn-outline-primary">ì‚¬ìš©ì ê´€ë¦¬</a>
                <a href="{{ url_for('admin_departments') }}" class="btn btn-outline-secondary">ì†Œì† ê´€ë¦¬</a>
                <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#meechulModal">ë¯¸ì¶œëŒ€ì‘</button>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
        
        <!-- í†µê³„ í˜„í™© ì„¹ì…˜ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">ì´ ì‘ì—…ì ìˆ˜</h5>
                        <h3 id="totalWorkers">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">ì˜¤ëŠ˜ ì‘ì—… ì°¸ì—¬ì</h5>
                        <h3 id="todayParticipants">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">ì˜¤ëŠ˜ ì§„í–‰ì¤‘ì¸ ì—…ë¬´</h5>
                        <h3 id="ongoingTasks">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">ì˜¤ëŠ˜ ì´ ì—…ë¬´ ìˆ˜</h5>
                        <h3 id="totalTasks">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- í•„í„° ë° ê²€ìƒ‰ ì„¹ì…˜ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">í•„í„° ë° ê²€ìƒ‰</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="departmentFilter" class="form-label">ì†Œì†</label>
                            <select class="form-select" id="departmentFilter">
                                <option value="">ì „ì²´ ì†Œì†</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="taskTypeFilter" class="form-label">ì—…ë¬´ ìœ í˜•</label>
                            <select class="form-select" id="taskTypeFilter">
                                <option value="">ì „ì²´ ìœ í˜•</option>
                                <option value="ì¸ì¶œ">ì¸ì¶œ</option>
                                <option value="ë³´ì¶©">ë³´ì¶©</option>
                                <option value="ì…ê³ ì§€ì›">ì…ê³ ì§€ì›</option>
                                <option value="ë¯¸ì¶œëŒ€ì‘">ë¯¸ì¶œëŒ€ì‘</option>
                                <option value="ë‹¨ë‚´ë¦¬ê¸°">ë‹¨ë‚´ë¦¬ê¸°</option>
                                <option value="ì´ê³ ">ì´ê³ </option>
                                <option value="ê³¼ì¶œ">ê³¼ì¶œ</option>
                                <option value="íŒŒì†">íŒŒì†</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="statusFilter" class="form-label">ìƒíƒœ</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">ì „ì²´ ìƒíƒœ</option>
                                <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                                <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="button" class="btn btn-primary" onclick="applyFilters()">í•„í„° ì ìš©</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="timeFilter" class="form-label">ì‹œê°„ëŒ€ ê²€ìƒ‰</label>
                            <div class="input-group">
                                <input type="time" class="form-control" id="timeFilterStart" placeholder="ì‹œì‘ ì‹œê°„">
                                <span class="input-group-text">~</span>
                                <input type="time" class="form-control" id="timeFilterEnd" placeholder="ì¢…ë£Œ ì‹œê°„">
                            </div>
                            <small class="form-text text-muted">ì˜ˆ: 09:00 ~ 12:00</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="startDate" class="form-label">ì‹œì‘ ë‚ ì§œ</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="endDate" class="form-label">ì¢…ë£Œ ë‚ ì§œ</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="button" class="btn btn-success" onclick="searchByPeriod()">ê¸°ê°„ ê²€ìƒ‰</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>ê¸°ë³¸ í‘œì‹œ:</strong> ì˜¤ëŠ˜ ë‚ ì§œì˜ ì—…ë¬´ë§Œ í‘œì‹œë©ë‹ˆë‹¤. ë‹¤ë¥¸ ë‚ ì§œì˜ ì—…ë¬´ë¥¼ ë³´ë ¤ë©´ ê¸°ê°„ ê²€ìƒ‰ì„ ì‚¬ìš©í•˜ì„¸ìš”.
                </div>
            </div>
        </div>

        <!-- ì—…ë¬´ ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-day text-primary me-2"></i>ì˜¤ëŠ˜ ì—…ë¬´ ëª©ë¡
                </h5>
                <div>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="showStatistics()">í†µê³„ ë³´ê¸°</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="tasksTable">
                        <thead>
                            <tr>
                                <th class="text-center">ì†Œì†</th>
                                <th class="text-center">ì‘ì—…ì</th>
                                <th class="text-center">ì—…ë¬´ ìœ í˜•</th>
                                <th class="text-center">ìƒíƒœ</th>
                                <th class="text-center">ì‹œì‘ ì‹œê°„</th>
                                <th class="text-center">ì¢…ë£Œ ì‹œê°„</th>
                                <th class="text-center">ì‘ì—…ì¼ì</th>
                                <th class="text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            <!-- ì—…ë¬´ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- í†µê³„ ëª¨ë‹¬ -->
<div class="modal fade" id="statisticsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ìƒì„¸ í†µê³„ í˜„í™©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>ì†Œì†ë³„ ì‘ì—… í˜„í™©</h6>
                        <div id="departmentStats"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>ì—…ë¬´ ìœ í˜•ë³„ í˜„í™©</h6>
                        <div id="taskTypeStats"></div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-12">
                        <h6>ì‹œê°„ëŒ€ë³„ ì°¸ì—¬ ì¸ì›</h6>
                        <div id="timeStats"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì—…ë¬´ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">ì—…ë¬´ ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editWorkDate" class="form-label">ì—…ë¬´ ë‚ ì§œ</label>
                                <input type="date" class="form-control date-input" id="editWorkDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTaskType" class="form-label">ì—…ë¬´ ìœ í˜•</label>
                                <select class="form-select task-type-select" id="editTaskType" required>
                                    <option value="">ì—…ë¬´ ìœ í˜• ì„ íƒ</option>
                                    <option value="ì¸ì¶œ">ì¸ì¶œ</option>
                                    <option value="ë³´ì¶©">ë³´ì¶©</option>
                                    <option value="ì…ê³ ì§€ì›">ì…ê³ ì§€ì›</option>
                                    <option value="ë¯¸ì¶œëŒ€ì‘">ë¯¸ì¶œëŒ€ì‘</option>
                                    <option value="ë‹¨ë‚´ë¦¬ê¸°">ë‹¨ë‚´ë¦¬ê¸°</option>
                                    <option value="ì´ê³ ">ì´ê³ </option>
                                    <option value="ê³¼ì¶œ">ê³¼ì¶œ</option>
                                    <option value="íŒŒì†">íŒŒì†</option>
                                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStartTime" class="form-label">ì‹œì‘ ì‹œê°„</label>
                                <input type="time" class="form-control time-input" id="editStartTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editEndTime" class="form-label">ì¢…ë£Œ ì‹œê°„</label>
                                <input type="time" class="form-control time-input" id="editEndTime">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">ì—…ë¬´ ë‚´ìš©</label>
                        <input type="text" class="form-control" id="editDescription" placeholder="ì—…ë¬´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="mb-3">
                        <label for="editCompleteDescription" class="form-label">ì™„ë£Œ ë‚´ìš©</label>
                        <input type="text" class="form-control" id="editCompleteDescription" placeholder="ì™„ë£Œëœ ì—…ë¬´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="saveTaskEdit()">ìˆ˜ì •</button>
                <button type="button" class="btn btn-danger" onclick="deleteTaskFromModal()">ì‚­ì œ</button>
            </div>
        </div>
    </div>
</div>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>ì—…ë¬´ ì‚­ì œ í™•ì¸
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <h6 class="alert-heading">âš ï¸ ì£¼ì˜ì‚¬í•­</h6>
                    <p class="mb-2">ì •ë§ë¡œ ì´ ì—…ë¬´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                    <ul class="mb-0">
                        <li>ì‚­ì œëœ ì—…ë¬´ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
                        <li>ëª¨ë“  ì—…ë¬´ ê¸°ë¡ì´ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.</li>
                    </ul>
                </div>
                <p class="text-muted small">ê³„ì†í•˜ì‹œë ¤ë©´ ì•„ë˜ "ì‚­ì œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteTask()">
                    <i class="fas fa-trash me-1"></i>ì‚­ì œ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ë¯¸ì¶œëŒ€ì‘ ëª¨ë‹¬ -->
<div class="modal fade" id="meechulModal" tabindex="-1" aria-labelledby="meechulModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="meechulModalLabel">
                    <i class="fas fa-file-excel text-success me-2"></i>ë¯¸ì¶œëŒ€ì‘ Excel ì •ë ¬
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6 class="alert-heading">ğŸ“‹ ë¯¸ì¶œëŒ€ì‘ ì •ë ¬ í”„ë¡œê·¸ë¨</h6>
                    <p class="mb-2">Excel íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ P1, P2, P3 ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <ul class="mb-0">
                        <li><strong>P1 ì •ë ¬:</strong> P1 ì½”ë“œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬</li>
                        <li><strong>P2 ì •ë ¬:</strong> P2 ì½”ë“œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬</li>
                        <li><strong>P3 ì •ë ¬:</strong> P3 ì½”ë“œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (P1/P2 ì¤‘ë³µ ì œê±°)</li>
                    </ul>
                </div>
                
                <form id="meechulForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="excelFile" class="form-label">Excel íŒŒì¼ ì„ íƒ</label>
                                <input type="file" class="form-control" id="excelFile" name="file" accept=".xlsx,.xls" required>
                                <div class="form-text">Excel íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="criteria" class="form-label">ì •ë ¬ ê¸°ì¤€</label>
                                <select class="form-select" id="criteria" name="criteria" required>
                                    <option value="P3">P3 ì •ë ¬ (ì¤‘ë³µ ì œê±°)</option>
                                    <option value="P1">P1 ì •ë ¬</option>
                                    <option value="P2">P2 ì •ë ¬</option>
                                </select>
                                <div class="form-text">ì •ë ¬í•  ê¸°ì¤€ ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success" id="processBtn">
                            <i class="fas fa-cog me-2"></i>ì •ë ¬ ì²˜ë¦¬ ì‹œì‘
                        </button>
                    </div>
                </form>
                
                <div id="processingStatus" class="mt-3" style="display: none;">
                    <div class="alert alert-warning">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">ì²˜ë¦¬ ì¤‘...</span>
                            </div>
                            <span>íŒŒì¼ì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</span>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                ì²˜ë¦¬ ê³¼ì •: íŒŒì¼ ì—…ë¡œë“œ â†’ Excel ë¶„ì„ â†’ ì •ë ¬ ì²˜ë¦¬ â†’ ê²°ê³¼ íŒŒì¼ ìƒì„±
                            </small>
                        </div>
                    </div>
                </div>
                
                <div id="resultStatus" class="mt-3" style="display: none;">
                    <div class="alert alert-success">
                        <h6 class="alert-heading">âœ… ì²˜ë¦¬ ì™„ë£Œ</h6>
                        <p id="resultMessage" class="mb-2"></p>
                        <div id="downloadSection" style="display: none;">
                            <a href="#" id="downloadLink" class="btn btn-primary btn-sm">
                                <i class="fas fa-download me-1"></i>ê²°ê³¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
let allTasks = [];
let filteredTasks = [];

// ì—ëŸ¬ ë©”ì‹œì§€ ì •ë¦¬ í•¨ìˆ˜
function cleanErrorMessage(error) {
    if (typeof error === 'string') {
        // URL íŒ¨í„´ ì œê±° (ë” ê°•ë ¥í•˜ê²Œ)
        let cleaned = error
            .replace(/https?:\/\/[^\s]+/g, '') // http/https URL ì œê±°
            .replace(/\/[^\s]+/g, '') // ìŠ¬ë˜ì‹œë¡œ ì‹œì‘í•˜ëŠ” ê²½ë¡œ ì œê±°
            .replace(/[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, '') // ë„ë©”ì¸ íŒ¨í„´ ì œê±°
            .replace(/localhost:\d+/g, '') // localhost í¬íŠ¸ ì œê±°
            .replace(/[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}:\d+/g, '') // ë„ë©”ì¸:í¬íŠ¸ íŒ¨í„´ ì œê±°
            .replace(/\/api\/[^\s]*/g, '') // API ê²½ë¡œ ì œê±°
            .replace(/\/[a-zA-Z0-9_-]+/g, '') // ì¼ë°˜ ê²½ë¡œ ì œê±°
            .replace(/\s+/g, ' ') // ì—°ì†ëœ ê³µë°±ì„ í•˜ë‚˜ë¡œ
            .trim();
        
        // ë¹ˆ ë¬¸ìì—´ì´ ë˜ë©´ ê¸°ë³¸ ë©”ì‹œì§€ ë°˜í™˜
        return cleaned || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    }
    if (error && error.error) {
        return cleanErrorMessage(error.error);
    }
    return 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', function() {
    loadTasks();
    loadDepartments();
    loadStatistics();
    
    // ë¯¸ì¶œëŒ€ì‘ í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('meechulForm').addEventListener('submit', handleMeechulSubmit);
});

// ì—…ë¬´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadTasks() {
    try {
        const response = await fetch('/api/admin/tasks');
        allTasks = await response.json();
        filteredTasks = [...allTasks];
        renderTasks();
    } catch (error) {
        console.error('ì—…ë¬´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
    }
}

// ì†Œì† ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadDepartments() {
    try {
        const response = await fetch('/api/departments');
        const departments = await response.json();
        
        const select = document.getElementById('departmentFilter');
        departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept.name;
            option.textContent = dept.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('ì†Œì† ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
    }
}

// í†µê³„ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadStatistics() {
    try {
        const response = await fetch('/api/admin/statistics');
        const statistics = await response.json();
        
        console.log('ë°›ì€ í†µê³„ ë°ì´í„°:', statistics);
        
        document.getElementById('totalWorkers').textContent = statistics.total_workers;
        document.getElementById('todayParticipants').textContent = statistics.today_participants;
        document.getElementById('ongoingTasks').textContent = statistics.ongoing_tasks;
        document.getElementById('totalTasks').textContent = statistics.total_tasks;
        
        console.log('í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    } catch (error) {
        console.error('í†µê³„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
    }
}

// ì—…ë¬´ ëª©ë¡ ë Œë”ë§
function renderTasks() {
    const tbody = document.getElementById('tasksTableBody');
    tbody.innerHTML = '';
    
    filteredTasks.forEach(task => {
        const row = `
            <tr>
                <td class="text-center">${task.users?.departments?.name || 'ë¯¸ì§€ì •'}</td>
                <td class="text-center">${task.users?.username || 'Unknown'}</td>
                <td class="text-center">${task.task_type}</td>
                <td class="text-center">
                    <span class="badge ${task.status === 'ì™„ë£Œ' ? 'bg-success' : 'bg-warning'}">
                        ${task.status}
                    </span>
                </td>
                <td class="text-center">${task.start_time}</td>
                <td class="text-center">${task.end_time || '-'}</td>
                <td class="text-center">${task.work_date || '-'}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="editTask(${task.id})">ìˆ˜ì •</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.id})">ì‚­ì œ</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// í•„í„° ì ìš©
function applyFilters() {
    const department = document.getElementById('departmentFilter').value;
    const taskType = document.getElementById('taskTypeFilter').value;
    const status = document.getElementById('statusFilter').value;
    const timeFilterStart = document.getElementById('timeFilterStart').value;
    const timeFilterEnd = document.getElementById('timeFilterEnd').value;
    
    filteredTasks = allTasks.filter(task => {
        let match = true;
        
        if (department && task.users?.departments?.name !== department) {
            match = false;
        }
        
        if (taskType && task.task_type !== taskType) {
            match = false;
        }
        
        if (status && task.status !== status) {
            match = false;
        }
        
        if (timeFilterStart && timeFilterEnd && task.start_time) {
            const taskStartHour = parseInt(task.start_time.split(':')[0]);
            const taskStartMinute = parseInt(task.start_time.split(':')[1]);
            const filterStartHour = parseInt(timeFilterStart.split(':')[0]);
            const filterStartMinute = parseInt(timeFilterStart.split(':')[1]);
            const filterEndHour = parseInt(timeFilterEnd.split(':')[0]);
            const filterEndMinute = parseInt(timeFilterEnd.split(':')[1]);
            
            // ì—…ë¬´ ì‹œì‘ ì‹œê°„ì„ ë¶„ ë‹¨ìœ„ë¡œ ë³€í™˜
            const taskStartMinutes = taskStartHour * 60 + taskStartMinute;
            const filterStartMinutes = filterStartHour * 60 + filterStartMinute;
            const filterEndMinutes = filterEndHour * 60 + filterEndMinute;
            
            // ì—…ë¬´ ì‹œì‘ ì‹œê°„ì´ í•„í„° ë²”ìœ„ ë°–ì´ë©´ ì œì™¸
            if (taskStartMinutes < filterStartMinutes || taskStartMinutes > filterEndMinutes) {
                match = false;
            }
        }
        
        return match;
    });
    
    renderTasks();
}

// ê¸°ê°„ ê²€ìƒ‰
function searchByPeriod() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert('ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    filteredTasks = allTasks.filter(task => {
        if (!task.work_date) return false;
        return task.work_date >= startDate && task.work_date <= endDate;
    });
    
    renderTasks();
}

// í†µê³„ ë³´ê¸°
function showStatistics() {
    const departmentStats = {};
    const taskTypeStats = {};
    const timeStats = {};
    
    allTasks.forEach(task => {
        // ì†Œì†ë³„ í†µê³„
        const deptName = task.users?.departments?.name || 'ë¯¸ì§€ì •';
        departmentStats[deptName] = (departmentStats[deptName] || 0) + 1;
        
        // ì—…ë¬´ ìœ í˜•ë³„ í†µê³„
        taskTypeStats[task.task_type] = (taskTypeStats[task.task_type] || 0) + 1;
        
        // ì‹œê°„ëŒ€ë³„ í†µê³„
        if (task.start_time) {
            const hour = parseInt(task.start_time.split(':')[0]);
            let timeRange = '';
            if (hour >= 9 && hour < 12) timeRange = '09:00-12:00';
            else if (hour >= 12 && hour < 15) timeRange = '12:00-15:00';
            else if (hour >= 15 && hour < 18) timeRange = '15:00-18:00';
            else if (hour >= 18 && hour < 21) timeRange = '18:00-21:00';
            else timeRange = 'ê¸°íƒ€';
            
            timeStats[timeRange] = (timeStats[timeRange] || 0) + 1;
        }
    });
    
    // í†µê³„ í‘œì‹œ
    document.getElementById('departmentStats').innerHTML = Object.entries(departmentStats)
        .map(([dept, count]) => `<div class="mb-2"><strong>${dept}:</strong> ${count}ê±´</div>`)
        .join('');
    
    document.getElementById('taskTypeStats').innerHTML = Object.entries(taskTypeStats)
        .map(([type, count]) => `<div class="mb-2"><strong>${type}:</strong> ${count}ê±´</div>`)
        .join('');
    
    document.getElementById('timeStats').innerHTML = Object.entries(timeStats)
        .map(([time, count]) => `<div class="mb-2"><strong>${time}:</strong> ${count}ê±´</div>`)
        .join('');
    
    new bootstrap.Modal(document.getElementById('statisticsModal')).show();
}



// ì—…ë¬´ ìˆ˜ì • (ëª¨ë‹¬)
async function editTask(taskId) {
    try {
        const response = await fetch(`/api/tasks/${taskId}`);
        if (response.ok) {
            const task = await response.json();
            
            // ëª¨ë‹¬ í¼ì— ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editWorkDate').value = task.work_date;
            document.getElementById('editStartTime').value = task.start_time;
            document.getElementById('editEndTime').value = task.end_time || '';
            document.getElementById('editTaskType').value = task.task_type;
            document.getElementById('editDescription').value = task.description || '';
            document.getElementById('editCompleteDescription').value = task.complete_description || '';
            
            // ëª¨ë‹¬ í‘œì‹œ
            const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            modal.show();
        } else {
            alert(cleanErrorMessage('ì—…ë¬´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
        }
    } catch (error) {
        alert(cleanErrorMessage(error));
    }
}

// ì—…ë¬´ ìˆ˜ì • ì €ì¥
async function saveTaskEdit() {
    const taskId = document.getElementById('editTaskId').value;
    const workDate = document.getElementById('editWorkDate').value;
    const startTime = document.getElementById('editStartTime').value;
    const endTime = document.getElementById('editEndTime').value;
    const taskType = document.getElementById('editTaskType').value;
    const description = document.getElementById('editDescription').value;
    const completeDescription = document.getElementById('editCompleteDescription').value;
    
    if (!workDate || !startTime || !taskType) {
        alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                work_date: workDate,
                start_time: startTime,
                end_time: endTime,
                task_type: taskType,
                description: description,
                complete_description: completeDescription
            })
        });
        
        if (response.ok) {
            // ëª¨ë‹¬ ë‹«ê¸°
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
            modal.hide();
            
            loadTasks();
            loadStatistics();
            alert('ì—…ë¬´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            const error = await response.json();
            alert(cleanErrorMessage(error));
        }
    } catch (error) {
        alert(cleanErrorMessage(error));
    }
}

// ì—…ë¬´ ì‚­ì œ
async function deleteTask(taskId) {
    if (!taskId) {
        alert('ì‚­ì œí•  ì—…ë¬´ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ì‚­ì œí•  ì—…ë¬´ ID ì €ì¥
    window.deleteTaskId = taskId;
    
    // ì‚­ì œ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
}

// ëª¨ë‹¬ì—ì„œ ì—…ë¬´ ì‚­ì œ
async function deleteTaskFromModal() {
    const taskId = document.getElementById('editTaskId').value;
    
    if (!taskId) {
        alert('ì‚­ì œí•  ì—…ë¬´ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ì‚­ì œí•  ì—…ë¬´ ID ì €ì¥
    window.deleteTaskId = taskId;
    
    // ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
    const editModal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
    editModal.hide();
    
    // ì‚­ì œ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
}

// ì‚­ì œ í™•ì¸ í›„ ì‹¤ì œ ì‚­ì œ ì‹¤í–‰
async function confirmDeleteTask() {
    const taskId = window.deleteTaskId;
    
    if (!taskId) {
        alert('ì‚­ì œí•  ì—…ë¬´ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ë‹«ê¸°
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
            deleteModal.hide();
            
            loadTasks();
            loadStatistics();
            alert('ì—…ë¬´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            const error = await response.json();
            alert(cleanErrorMessage(error));
        }
    } catch (error) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
        alert(cleanErrorMessage(error));
    }
}

// ë¯¸ì¶œëŒ€ì‘ ì²˜ë¦¬ í•¨ìˆ˜
async function handleMeechulSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('excelFile');
    const criteriaSelect = document.getElementById('criteria');
    
    if (!fileInput.files[0]) {
        alert('Excel íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    formData.append('file', fileInput.files[0]);
    formData.append('criteria', criteriaSelect.value);
    
    // UI ìƒíƒœ ë³€ê²½
    const processBtn = document.getElementById('processBtn');
    const processingStatus = document.getElementById('processingStatus');
    const resultStatus = document.getElementById('resultStatus');
    
    processBtn.disabled = true;
    processBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ì²˜ë¦¬ ì¤‘...';
    processingStatus.style.display = 'block';
    resultStatus.style.display = 'none';
    
    try {
        const response = await fetch('/api/meechul-process', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            // ì„±ê³µ ì²˜ë¦¬
            document.getElementById('resultMessage').textContent = result.message;
            document.getElementById('downloadLink').href = result.download_url;
            document.getElementById('downloadSection').style.display = 'block';
            resultStatus.style.display = 'block';
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('meechulForm').reset();
        } else {
            // ì˜¤ë¥˜ ì²˜ë¦¬
            const errorMessage = result.error || 'íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            console.error('ë¯¸ì¶œëŒ€ì‘ ì²˜ë¦¬ ì˜¤ë¥˜:', result);
            alert(cleanErrorMessage(errorMessage));
        }
    } catch (error) {
        console.error('ë¯¸ì¶œëŒ€ì‘ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        alert(cleanErrorMessage(error));
    } finally {
        // UI ìƒíƒœ ë³µì›
        processBtn.disabled = false;
        processBtn.innerHTML = '<i class="fas fa-cog me-2"></i>ì •ë ¬ ì²˜ë¦¬ ì‹œì‘';
        processingStatus.style.display = 'none';
    }
}



// ë¯¸ì¶œëŒ€ì‘ ëª¨ë‹¬ ì´ˆê¸°í™”
document.getElementById('meechulModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('meechulForm').reset();
    document.getElementById('processingStatus').style.display = 'none';
    document.getElementById('resultStatus').style.display = 'none';
    document.getElementById('downloadSection').style.display = 'none';
    
    const processBtn = document.getElementById('processBtn');
    processBtn.disabled = false;
    processBtn.innerHTML = '<i class="fas fa-cog me-2"></i>ì •ë ¬ ì²˜ë¦¬ ì‹œì‘';
});

</script>
{% endblock %} 