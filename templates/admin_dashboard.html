{% extends "base.html" %}

{% block title %}관리자 대시보드 - 다이소 안성센터{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>관리자 대시보드</h2>
                <p class="text-muted">전체 사용자의 업무 현황을 확인할 수 있습니다.</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('admin_users') }}" class="btn btn-outline-primary">사용자 관리</a>
                <a href="{{ url_for('admin_departments') }}" class="btn btn-outline-secondary">소속 관리</a>
                <a href="{{ url_for('missing_response') }}" class="btn btn-outline-warning">미출대응</a>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">로그아웃</a>
            </div>
        </div>
        
        <!-- 통계 현황 섹션 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">총 작업자 수</h5>
                        <h3 id="totalWorkers">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">오늘 작업 참여자</h5>
                        <h3 id="todayParticipants">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">오늘 진행중인 업무</h5>
                        <h3 id="ongoingTasks">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">오늘 총 업무 수</h5>
                        <h3 id="totalTasks">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- 필터 및 검색 섹션 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">필터 및 검색</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="departmentFilter" class="form-label">소속</label>
                            <select class="form-select" id="departmentFilter">
                                <option value="">전체 소속</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="taskTypeFilter" class="form-label">업무 유형</label>
                            <select class="form-select" id="taskTypeFilter">
                                <option value="">전체 유형</option>
                                <option value="인출">인출</option>
                                <option value="보충">보충</option>
                                <option value="입고지원">입고지원</option>
                                <option value="미출대응">미출대응</option>
                                <option value="단내리기">단내리기</option>
                                <option value="이고">이고</option>
                                <option value="과출">과출</option>
                                <option value="파손">파손</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="statusFilter" class="form-label">상태</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">전체 상태</option>
                                <option value="진행중">진행중</option>
                                <option value="완료">완료</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="button" class="btn btn-primary" onclick="applyFilters()">필터 적용</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="timeFilter" class="form-label">시간대 검색</label>
                            <div class="input-group">
                                <input type="time" class="form-control" id="timeFilterStart" placeholder="시작 시간">
                                <span class="input-group-text">~</span>
                                <input type="time" class="form-control" id="timeFilterEnd" placeholder="종료 시간">
                            </div>
                            <small class="form-text text-muted">예: 09:00 ~ 12:00</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="startDate" class="form-label">시작 날짜</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="endDate" class="form-label">종료 날짜</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="button" class="btn btn-success" onclick="searchByPeriod()">기간 검색</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 업무 관리 섹션 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">전체 업무 목록</h5>
                <div>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="showStatistics()">통계 보기</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="tasksTable">
                        <thead>
                            <tr>
                                <th class="text-center">소속</th>
                                <th class="text-center">작업자</th>
                                <th class="text-center">업무 유형</th>
                                <th class="text-center">상태</th>
                                <th class="text-center">시작 시간</th>
                                <th class="text-center">종료 시간</th>
                                <th class="text-center">작업일자</th>
                                <th class="text-center">관리</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            <!-- 업무 목록이 여기에 동적으로 로드됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 통계 모달 -->
<div class="modal fade" id="statisticsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">상세 통계 현황</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>소속별 작업 현황</h6>
                        <div id="departmentStats"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>업무 유형별 현황</h6>
                        <div id="taskTypeStats"></div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-12">
                        <h6>시간대별 참여 인원</h6>
                        <div id="timeStats"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 업무 수정 모달 -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">업무 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editWorkDate" class="form-label">업무 날짜</label>
                                <input type="date" class="form-control date-input" id="editWorkDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTaskType" class="form-label">업무 유형</label>
                                <select class="form-select task-type-select" id="editTaskType" required>
                                    <option value="">업무 유형 선택</option>
                                    <option value="인출">인출</option>
                                    <option value="보충">보충</option>
                                    <option value="입고지원">입고지원</option>
                                    <option value="미출대응">미출대응</option>
                                    <option value="단내리기">단내리기</option>
                                    <option value="이고">이고</option>
                                    <option value="과출">과출</option>
                                    <option value="파손">파손</option>
                                    <option value="기타">기타</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStartTime" class="form-label">시작 시간</label>
                                <input type="time" class="form-control time-input" id="editStartTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editEndTime" class="form-label">종료 시간</label>
                                <input type="time" class="form-control time-input" id="editEndTime">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">업무 내용</label>
                        <input type="text" class="form-control" id="editDescription" placeholder="업무 내용을 입력하세요">
                    </div>
                    <div class="mb-3">
                        <label for="editCompleteDescription" class="form-label">완료 내용</label>
                        <input type="text" class="form-control" id="editCompleteDescription" placeholder="완료된 업무 내용을 입력하세요">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveTaskEdit()">수정</button>
                <button type="button" class="btn btn-danger" onclick="deleteTaskFromModal()">삭제</button>
            </div>
        </div>
    </div>
</div>

<!-- 삭제 확인 모달 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>업무 삭제 확인
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <h6 class="alert-heading">⚠️ 주의사항</h6>
                    <p class="mb-2">정말로 이 업무를 삭제하시겠습니까?</p>
                    <ul class="mb-0">
                        <li>삭제된 업무는 복구할 수 없습니다.</li>
                        <li>모든 업무 기록이 영구적으로 삭제됩니다.</li>
                    </ul>
                </div>
                <p class="text-muted small">계속하시려면 아래 "삭제" 버튼을 클릭하세요.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteTask()">
                    <i class="fas fa-trash me-1"></i>삭제
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let allTasks = [];
let filteredTasks = [];

// 에러 메시지 정리 함수
function cleanErrorMessage(error) {
    if (typeof error === 'string') {
        // URL 패턴 제거
        return error.replace(/https?:\/\/[^\s]+/g, '').replace(/\/[^\s]+/g, '').trim();
    }
    if (error && error.error) {
        return cleanErrorMessage(error.error);
    }
    return '오류가 발생했습니다.';
}

// 페이지 로드 시 데이터 불러오기
document.addEventListener('DOMContentLoaded', function() {
    loadTasks();
    loadDepartments();
    loadStatistics();
});

// 업무 목록 불러오기
async function loadTasks() {
    try {
        const response = await fetch('/api/admin/tasks');
        allTasks = await response.json();
        filteredTasks = [...allTasks];
        renderTasks();
    } catch (error) {
        console.error('업무 목록 불러오기 실패:', error);
    }
}

// 소속 목록 불러오기
async function loadDepartments() {
    try {
        const response = await fetch('/api/departments');
        const departments = await response.json();
        
        const select = document.getElementById('departmentFilter');
        departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept.name;
            option.textContent = dept.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('소속 목록 불러오기 실패:', error);
    }
}

// 통계 불러오기
async function loadStatistics() {
    try {
        const response = await fetch('/api/admin/statistics');
        const statistics = await response.json();
        
        console.log('받은 통계 데이터:', statistics);
        
        document.getElementById('totalWorkers').textContent = statistics.total_workers;
        document.getElementById('todayParticipants').textContent = statistics.today_participants;
        document.getElementById('ongoingTasks').textContent = statistics.ongoing_tasks;
        document.getElementById('totalTasks').textContent = statistics.total_tasks;
        
        console.log('통계 업데이트 완료');
    } catch (error) {
        console.error('통계 불러오기 실패:', error);
    }
}

// 업무 목록 렌더링
function renderTasks() {
    const tbody = document.getElementById('tasksTableBody');
    tbody.innerHTML = '';
    
    filteredTasks.forEach(task => {
        const row = `
            <tr>
                <td class="text-center">${task.users?.departments?.name || '미지정'}</td>
                <td class="text-center">${task.users?.username || 'Unknown'}</td>
                <td class="text-center">${task.task_type}</td>
                <td class="text-center">
                    <span class="badge ${task.status === '완료' ? 'bg-success' : 'bg-warning'}">
                        ${task.status}
                    </span>
                </td>
                <td class="text-center">${task.start_time}</td>
                <td class="text-center">${task.end_time || '-'}</td>
                <td class="text-center">${task.work_date || '-'}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="editTask(${task.id})">수정</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.id})">삭제</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// 필터 적용
function applyFilters() {
    const department = document.getElementById('departmentFilter').value;
    const taskType = document.getElementById('taskTypeFilter').value;
    const status = document.getElementById('statusFilter').value;
    const timeFilterStart = document.getElementById('timeFilterStart').value;
    const timeFilterEnd = document.getElementById('timeFilterEnd').value;
    
    filteredTasks = allTasks.filter(task => {
        let match = true;
        
        if (department && task.users?.departments?.name !== department) {
            match = false;
        }
        
        if (taskType && task.task_type !== taskType) {
            match = false;
        }
        
        if (status && task.status !== status) {
            match = false;
        }
        
        if (timeFilterStart && timeFilterEnd && task.start_time) {
            const taskStartHour = parseInt(task.start_time.split(':')[0]);
            const taskStartMinute = parseInt(task.start_time.split(':')[1]);
            const filterStartHour = parseInt(timeFilterStart.split(':')[0]);
            const filterStartMinute = parseInt(timeFilterStart.split(':')[1]);
            const filterEndHour = parseInt(timeFilterEnd.split(':')[0]);
            const filterEndMinute = parseInt(timeFilterEnd.split(':')[1]);
            
            // 업무 시작 시간을 분 단위로 변환
            const taskStartMinutes = taskStartHour * 60 + taskStartMinute;
            const filterStartMinutes = filterStartHour * 60 + filterStartMinute;
            const filterEndMinutes = filterEndHour * 60 + filterEndMinute;
            
            // 업무 시작 시간이 필터 범위 밖이면 제외
            if (taskStartMinutes < filterStartMinutes || taskStartMinutes > filterEndMinutes) {
                match = false;
            }
        }
        
        return match;
    });
    
    renderTasks();
}

// 기간 검색
function searchByPeriod() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert('시작 날짜와 종료 날짜를 모두 입력해주세요.');
        return;
    }
    
    filteredTasks = allTasks.filter(task => {
        if (!task.work_date) return false;
        return task.work_date >= startDate && task.work_date <= endDate;
    });
    
    renderTasks();
}

// 통계 보기
function showStatistics() {
    const departmentStats = {};
    const taskTypeStats = {};
    const timeStats = {};
    
    allTasks.forEach(task => {
        // 소속별 통계
        const deptName = task.users?.departments?.name || '미지정';
        departmentStats[deptName] = (departmentStats[deptName] || 0) + 1;
        
        // 업무 유형별 통계
        taskTypeStats[task.task_type] = (taskTypeStats[task.task_type] || 0) + 1;
        
        // 시간대별 통계
        if (task.start_time) {
            const hour = parseInt(task.start_time.split(':')[0]);
            let timeRange = '';
            if (hour >= 9 && hour < 12) timeRange = '09:00-12:00';
            else if (hour >= 12 && hour < 15) timeRange = '12:00-15:00';
            else if (hour >= 15 && hour < 18) timeRange = '15:00-18:00';
            else if (hour >= 18 && hour < 21) timeRange = '18:00-21:00';
            else timeRange = '기타';
            
            timeStats[timeRange] = (timeStats[timeRange] || 0) + 1;
        }
    });
    
    // 통계 표시
    document.getElementById('departmentStats').innerHTML = Object.entries(departmentStats)
        .map(([dept, count]) => `<div class="mb-2"><strong>${dept}:</strong> ${count}건</div>`)
        .join('');
    
    document.getElementById('taskTypeStats').innerHTML = Object.entries(taskTypeStats)
        .map(([type, count]) => `<div class="mb-2"><strong>${type}:</strong> ${count}건</div>`)
        .join('');
    
    document.getElementById('timeStats').innerHTML = Object.entries(timeStats)
        .map(([time, count]) => `<div class="mb-2"><strong>${time}:</strong> ${count}건</div>`)
        .join('');
    
    new bootstrap.Modal(document.getElementById('statisticsModal')).show();
}



// 업무 수정 (모달)
async function editTask(taskId) {
    try {
        const response = await fetch(`/api/tasks/${taskId}`);
        if (response.ok) {
            const task = await response.json();
            
            // 모달 폼에 데이터 채우기
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editWorkDate').value = task.work_date;
            document.getElementById('editStartTime').value = task.start_time;
            document.getElementById('editEndTime').value = task.end_time || '';
            document.getElementById('editTaskType').value = task.task_type;
            document.getElementById('editDescription').value = task.description || '';
            document.getElementById('editCompleteDescription').value = task.complete_description || '';
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            modal.show();
        } else {
            alert(cleanErrorMessage('업무 정보를 불러오는데 실패했습니다.'));
        }
    } catch (error) {
        alert(cleanErrorMessage(error));
    }
}

// 업무 수정 저장
async function saveTaskEdit() {
    const taskId = document.getElementById('editTaskId').value;
    const workDate = document.getElementById('editWorkDate').value;
    const startTime = document.getElementById('editStartTime').value;
    const endTime = document.getElementById('editEndTime').value;
    const taskType = document.getElementById('editTaskType').value;
    const description = document.getElementById('editDescription').value;
    const completeDescription = document.getElementById('editCompleteDescription').value;
    
    if (!workDate || !startTime || !taskType) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
    }
    
    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                work_date: workDate,
                start_time: startTime,
                end_time: endTime,
                task_type: taskType,
                description: description,
                complete_description: completeDescription
            })
        });
        
        if (response.ok) {
            // 모달 닫기
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
            modal.hide();
            
            loadTasks();
            loadStatistics();
            alert('업무가 수정되었습니다.');
        } else {
            const error = await response.json();
            alert(cleanErrorMessage(error));
        }
    } catch (error) {
        alert(cleanErrorMessage(error));
    }
}

// 업무 삭제
async function deleteTask(taskId) {
    if (!taskId) {
        alert('삭제할 업무 ID가 없습니다.');
        return;
    }
    
    // 삭제할 업무 ID 저장
    window.deleteTaskId = taskId;
    
    // 삭제 확인 모달 표시
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
}

// 모달에서 업무 삭제
async function deleteTaskFromModal() {
    const taskId = document.getElementById('editTaskId').value;
    
    if (!taskId) {
        alert('삭제할 업무 ID가 없습니다.');
        return;
    }
    
    // 삭제할 업무 ID 저장
    window.deleteTaskId = taskId;
    
    // 수정 모달 닫기
    const editModal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
    editModal.hide();
    
    // 삭제 확인 모달 표시
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
}

// 삭제 확인 후 실제 삭제 실행
async function confirmDeleteTask() {
    const taskId = window.deleteTaskId;
    
    if (!taskId) {
        alert('삭제할 업무 ID가 없습니다.');
        return;
    }
    
    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // 삭제 확인 모달 닫기
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
            deleteModal.hide();
            
            loadTasks();
            loadStatistics();
            alert('업무가 삭제되었습니다.');
        } else {
            const error = await response.json();
            alert(cleanErrorMessage(error));
        }
    } catch (error) {
        console.error('삭제 오류:', error);
        alert(cleanErrorMessage(error));
    }
}


</script>
{% endblock %} 