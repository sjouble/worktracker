{% extends "base.html" %}

{% block title %}사용자 관리 - 다이소 안성센터{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>작업자 관리</h2>
                <p class="text-muted">전체 작업자 목록을 관리할 수 있습니다.</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">대시보드</a>
                <a href="{{ url_for('admin_departments') }}" class="btn btn-outline-secondary">소속 관리</a>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">로그아웃</a>
            </div>
        </div>
        
        <!-- 사용자 목록 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">전체 작업자 목록</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="usersTable">
                        <thead>
                            <tr>
                                <th>작업자명</th>
                                <th>소속</th>
                                <th>가입일</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 사용자 목록이 여기에 동적으로 로드됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 소속 변경 모달 -->
<div class="modal fade" id="userDepartmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">작업자 소속 변경</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userDepartmentForm">
                    <div class="mb-3">
                        <label for="userDepartmentSelect" class="form-label">소속 선택</label>
                        <select class="form-select" id="userDepartmentSelect" required>
                            <!-- 소속 옵션이 동적으로 로드됩니다 -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="updateUserDepartment()">변경</button>
            </div>
        </div>
    </div>
</div>

<!-- 비밀번호 초기화 확인 모달 -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">비밀번호 초기화</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>정말로 <strong id="resetUserName"></strong> 작업자의 비밀번호를 초기화하시겠습니까?</p>
                <p class="text-muted">초기화된 비밀번호는 <strong>1234</strong>로 설정됩니다.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-warning" onclick="confirmResetPassword()">초기화</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentUserId = null;
let currentUserName = null;

// 에러 메시지 정리 함수
function cleanErrorMessage(error) {
    if (typeof error === 'string') {
        // URL 패턴 제거 (더 강력하게)
        let cleaned = error
            .replace(/https?:\/\/[^\s]+/g, '') // http/https URL 제거
            .replace(/\/[^\s]+/g, '') // 슬래시로 시작하는 경로 제거
            .replace(/[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, '') // 도메인 패턴 제거
            .replace(/localhost:\d+/g, '') // localhost 포트 제거
            .replace(/\s+/g, ' ') // 연속된 공백을 하나로
            .trim();
        
        // 빈 문자열이 되면 기본 메시지 반환
        return cleaned || '오류가 발생했습니다.';
    }
    if (error && error.error) {
        return cleanErrorMessage(error.error);
    }
    return '오류가 발생했습니다.';
}

// 페이지 로드 시 사용자 목록 불러오기
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
});

// 작업자 목록 불러오기
async function loadUsers() {
    try {
        const response = await fetch('/api/users');
        const users = await response.json();
        
        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = '';
        
        users.forEach(user => {
            const row = `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.department_name || '미지정'}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="changeUserDepartment('${user.id}', '${user.username}', ${user.department_id})">소속 변경</button>
                            <button class="btn btn-sm btn-outline-warning" onclick="resetPassword('${user.id}', '${user.username}')">비밀번호 초기화</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}', '${user.username}')">삭제</button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    } catch (error) {
        console.error('작업자 목록 불러오기 실패:', error);
    }
}

// 작업자 소속 변경 모달 열기
async function changeUserDepartment(userId, username, currentDepartmentId) {
    currentUserId = userId;
    
    try {
        const response = await fetch('/api/departments');
        const departments = await response.json();
        
        const select = document.getElementById('userDepartmentSelect');
        select.innerHTML = '<option value="">소속을 선택하세요</option>';
        
        departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept.id;
            option.textContent = dept.name;
            if (dept.id === currentDepartmentId) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        new bootstrap.Modal(document.getElementById('userDepartmentModal')).show();
    } catch (error) {
        alert(cleanErrorMessage(error));
    }
}

// 작업자 소속 업데이트
async function updateUserDepartment() {
    const departmentId = document.getElementById('userDepartmentSelect').value;
    if (!departmentId) {
        alert('소속을 선택해주세요.');
        return;
    }
    
    try {
        const response = await fetch(`/api/users/${currentUserId}/department`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ department_id: parseInt(departmentId) })
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('userDepartmentModal')).hide();
            loadUsers();
            alert('작업자 소속이 변경되었습니다.');
        } else {
            const error = await response.json();
            alert(cleanErrorMessage(error));
        }
    } catch (error) {
        alert(cleanErrorMessage(error));
    }
}

// 비밀번호 초기화 모달 열기
function resetPassword(userId, username) {
    currentUserId = userId;
    currentUserName = username;
    document.getElementById('resetUserName').textContent = username;
    new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
}

// 비밀번호 초기화 확인
async function confirmResetPassword() {
    try {
        const response = await fetch(`/api/users/${currentUserId}/reset-password`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
            alert('비밀번호가 초기화되었습니다. (새 비밀번호: 1234)');
        } else {
            const error = await response.json();
            alert(cleanErrorMessage(error));
        }
    } catch (error) {
        alert(cleanErrorMessage(error));
    }
}

// 작업자 삭제
async function deleteUser(userId, username) {
    if (!confirm(`정말로 ${username} 작업자를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/users/${userId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadUsers();
            alert('작업자가 삭제되었습니다.');
        } else {
            const error = await response.json();
            alert(cleanErrorMessage(error));
        }
    } catch (error) {
        alert(cleanErrorMessage(error));
    }
}
</script>
{% endblock %} 