{% extends "base.html" %}

{% block title %}업무 대시보드 - 다이소 안성센터{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>안녕하세요, {{ user.username }}님!</h2>
                <p class="text-muted">소속: {{ user.department_name if user.department_name else '미지정' }}</p>
            </div>
            <div>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">로그아웃</a>
            </div>
        </div>
        
        <!-- 새 업무 시작 섹션 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">새 업무 시작</h5>
            </div>
            <div class="card-body">
                <form id="taskForm">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="workDate" class="form-label">업무 날짜</label>
                                <input type="date" class="form-control date-input" id="workDate" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="startTime" class="form-label">시작 시간</label>
                                <input type="time" class="form-control time-input" id="startTime" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="taskType" class="form-label">업무 유형</label>
                                <select class="form-select task-type-select" id="taskType" required>
                                    <option value="">업무 유형 선택</option>
                                    <option value="인출">인출</option>
                                    <option value="보충">보충</option>
                                    <option value="입고지원">입고지원</option>
                                    <option value="미출대응">미출대응</option>
                                    <option value="단내리기">단내리기</option>
                                    <option value="이고">이고</option>
                                    <option value="과출">과출</option>
                                    <option value="파손">파손</option>
                                    <option value="기타">기타</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="description" class="form-label">업무 내용</label>
                                <input type="text" class="form-control" id="description" placeholder="업무 내용을 입력하세요">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">업무 시작</button>
                </form>
            </div>
        </div>
        
        <!-- 현재 진행 중인 업무 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-clock text-warning me-2"></i>현재 진행 중인 업무
                </h5>
                <span class="badge bg-warning text-dark" id="currentTasksCount">0</span>
            </div>
            <div class="card-body p-0">
                <div id="currentTasks" class="task-cards-container">
                    <!-- JS로 동적 생성 -->
                </div>
            </div>
        </div>
        
        <!-- 업무 완료 처리 -->
        <div class="card mb-4 complete-form" id="completeTaskCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">업무 완료</h5>
            </div>
            <div class="card-body">
                <form id="completeTaskForm">
                    <input type="hidden" id="completeTaskId">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="endTime" class="form-label">종료 시간</label>
                                <input type="time" class="form-control time-input" id="endTime" required>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="completeDescription" class="form-label">완료 내용</label>
                                <input type="text" class="form-control" id="completeDescription" placeholder="완료된 업무 내용을 입력하세요">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">업무 완료</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelComplete()">취소</button>
                </form>
            </div>
        </div>
        
        <!-- 조회 필터 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">업무 조회</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="filterType" class="form-label">조회 유형</label>
                            <select class="form-select" id="filterType">
                                <option value="today">오늘</option>
                                <option value="date">특정 날짜</option>
                                <option value="period">기간</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3" id="dateFilter" style="display: none;">
                        <div class="mb-3">
                            <label for="filterDate" class="form-label">날짜 선택</label>
                            <input type="date" class="form-control" id="filterDate">
                        </div>
                    </div>
                    <div class="col-md-3" id="startDateFilter" style="display: none;">
                        <div class="mb-3">
                            <label for="filterStartDate" class="form-label">시작 날짜</label>
                            <input type="date" class="form-control" id="filterStartDate">
                        </div>
                    </div>
                    <div class="col-md-3" id="endDateFilter" style="display: none;">
                        <div class="mb-3">
                            <label for="filterEndDate" class="form-label">종료 날짜</label>
                            <input type="date" class="form-control" id="filterEndDate">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-primary d-block" onclick="loadTasks()">조회</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 완료된 업무 목록 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle text-success me-2"></i><span id="completedTasksTitle">완료된 업무 목록</span>
                </h5>
                <span class="badge bg-success" id="completedTasksCount">0</span>
            </div>
            <div class="card-body p-0">
                <div id="completedTasksContainer" class="task-cards-container">
                    <!-- JS로 동적 생성 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 업무 수정 모달 -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">업무 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editWorkDate" class="form-label">업무 날짜</label>
                                <input type="date" class="form-control date-input" id="editWorkDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTaskType" class="form-label">업무 유형</label>
                                <select class="form-select task-type-select" id="editTaskType" required>
                                    <option value="">업무 유형 선택</option>
                                    <option value="인출">인출</option>
                                    <option value="보충">보충</option>
                                    <option value="입고지원">입고지원</option>
                                    <option value="미출대응">미출대응</option>
                                    <option value="단내리기">단내리기</option>
                                    <option value="이고">이고</option>
                                    <option value="과출">과출</option>
                                    <option value="파손">파손</option>
                                    <option value="기타">기타</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStartTime" class="form-label">시작 시간</label>
                                <input type="time" class="form-control time-input" id="editStartTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editEndTime" class="form-label">종료 시간</label>
                                <input type="time" class="form-control time-input" id="editEndTime">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">업무 내용</label>
                        <input type="text" class="form-control" id="editDescription" placeholder="업무 내용을 입력하세요">
                    </div>
                    <div class="mb-3">
                        <label for="editCompleteDescription" class="form-label">완료 내용</label>
                        <input type="text" class="form-control" id="editCompleteDescription" placeholder="완료된 업무 내용을 입력하세요">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveTaskEdit()">수정</button>
                <button type="button" class="btn btn-danger" onclick="deleteTaskFromModal()">삭제</button>
            </div>
        </div>
    </div>
</div>

<!-- 삭제 확인 모달 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>업무 삭제 확인
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <h6 class="alert-heading">⚠️ 주의사항</h6>
                    <p class="mb-2">정말로 이 업무를 삭제하시겠습니까?</p>
                    <ul class="mb-0">
                        <li>삭제된 업무는 복구할 수 없습니다.</li>
                        <li>모든 업무 기록이 영구적으로 삭제됩니다.</li>
                    </ul>
                </div>
                <p class="text-muted small">계속하시려면 아래 "삭제" 버튼을 클릭하세요.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteTask()">
                    <i class="fas fa-trash me-1"></i>삭제
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.work-row {
  display: flex;
  flex-wrap: wrap;
  margin-bottom: 1.5rem;
  background: #f8f9fa;
  border-radius: 0.5rem;
  padding: 1rem 0.5rem;
  box-shadow: 0 1px 4px rgba(0,0,0,0.03);
}
.work-cell {
  flex: 0 0 25%;
  max-width: 25%;
  padding: 0.5rem 0.5rem;
  text-align: center;
  font-size: 1rem;
  word-break: keep-all;
}
.work-label {
  color: #888;
  font-size: 0.95em;
  margin-bottom: 0.25em;
  display: block;
}
.work-btns {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  margin-top: 0.5rem;
}

/* 업무 카드 컨테이너 */
.task-cards-container {
  max-height: 600px;
  overflow-y: auto;
}

/* 업무 카드 스타일 */
.task-card {
  border: 1px solid #e9ecef;
  border-radius: 12px;
  margin-bottom: 1rem;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
  overflow: hidden;
}

.task-card:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  transform: translateY(-2px);
}

.task-card.current {
  border-left: 4px solid #ffc107;
}

.task-card.completed {
  border-left: 4px solid #198754;
}

.task-card-header {
  padding: 1rem;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-bottom: 1px solid #e9ecef;
}

.task-card-body {
  padding: 1rem;
}

.task-type-badge {
  font-size: 0.875rem;
  font-weight: 600;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  display: inline-block;
  margin-bottom: 0.5rem;
}

.task-type-badge.인출 { background: #e3f2fd; color: #1976d2; }
.task-type-badge.보충 { background: #f3e5f5; color: #7b1fa2; }
.task-type-badge.입고지원 { background: #e8f5e8; color: #388e3c; }
.task-type-badge.미출대응 { background: #fff3e0; color: #f57c00; }
.task-type-badge.단내리기 { background: #fce4ec; color: #c2185b; }
.task-type-badge.이고 { background: #e0f2f1; color: #00695c; }
.task-type-badge.과출 { background: #f1f8e9; color: #689f38; }
.task-type-badge.파손 { background: #ffebee; color: #d32f2f; }
.task-type-badge.기타 { background: #fafafa; color: #616161; }

.task-status-badge {
  font-size: 0.75rem;
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-weight: 500;
}

.task-status-badge.progress {
  background: #fff3cd;
  color: #856404;
}

.task-status-badge.completed {
  background: #d1e7dd;
  color: #0f5132;
}

.task-info {
  margin: 0.75rem 0;
}

.task-info-item {
  display: flex;
  align-items: center;
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
  color: #6c757d;
}

.task-info-item i {
  width: 16px;
  margin-right: 0.5rem;
  color: #adb5bd;
}

.task-description {
  background: #f8f9fa;
  padding: 0.75rem;
  border-radius: 8px;
  margin: 0.75rem 0;
  border-left: 3px solid #dee2e6;
}

.task-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
  flex-wrap: wrap;
}

.task-actions .btn {
  flex: 1;
  min-width: 80px;
  font-size: 0.875rem;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-weight: 500;
}

.empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: #6c757d;
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-state p {
  margin: 0;
  font-size: 1rem;
}

/* 반응형 디자인 */
@media (max-width: 768px) {
  .task-card {
    margin-bottom: 0.75rem;
    border-radius: 8px;
  }
  
  .task-card-header {
    padding: 0.75rem;
  }
  
  .task-card-body {
    padding: 0.75rem;
  }
  
  .task-type-badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
  }
  
  .task-actions {
    flex-direction: column;
  }
  
  .task-actions .btn {
    width: 100%;
    margin-bottom: 0.25rem;
  }
  
  .task-info-item {
    font-size: 0.8rem;
  }
}

@media (max-width: 576px) {
  .task-card-header {
    padding: 0.5rem;
  }
  
  .task-card-body {
    padding: 0.5rem;
  }
  
  .task-type-badge {
    font-size: 0.75rem;
    padding: 0.3rem 0.6rem;
  }
  
  .task-description {
    padding: 0.5rem;
    font-size: 0.875rem;
  }
}
</style>

<script>
// 한국 시간대 함수
function getKoreanTime() {
    const now = new Date();
    const koreanTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
    return koreanTime;
}

function getKoreanDateString() {
    const now = new Date();
    const formatter = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'Asia/Seoul',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
    return formatter.format(now);
}

function getKoreanTimeString() {
    const now = new Date();
    const formatter = new Intl.DateTimeFormat('en-US', {
        timeZone: 'Asia/Seoul',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
    return formatter.format(now);
}

// 에러 메시지 정리 함수
function cleanErrorMessage(error) {
    if (typeof error === 'string') {
        // URL 패턴 제거 (더 강력하게)
        let cleaned = error
            .replace(/https?:\/\/[^\s]+/g, '') // http/https URL 제거
            .replace(/\/[^\s]+/g, '') // 슬래시로 시작하는 경로 제거
            .replace(/[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, '') // 도메인 패턴 제거
            .replace(/localhost:\d+/g, '') // localhost 포트 제거
            .replace(/[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}:\d+/g, '') // 도메인:포트 패턴 제거
            .replace(/\/api\/[^\s]*/g, '') // API 경로 제거
            .replace(/\/[a-zA-Z0-9_-]+/g, '') // 일반 경로 제거
            .replace(/\s+/g, ' ') // 연속된 공백을 하나로
            .trim();
        
        // 빈 문자열이 되면 기본 메시지 반환
        return cleaned || '오류가 발생했습니다.';
    }
    if (error && error.error) {
        return cleanErrorMessage(error.error);
    }
    return '오류가 발생했습니다.';
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 오늘 날짜를 기본값으로 설정 (한국 시간 기준)
    const today = getKoreanDateString();
    document.getElementById('workDate').value = today;
    
    // 현재 시간을 기본값으로 설정 (24시간 형식, 한국 시간 기준)
    const currentTime = getKoreanTimeString();
    document.getElementById('startTime').value = currentTime;
    
    // 조회 필터 이벤트 리스너
    document.getElementById('filterType').addEventListener('change', function() {
        const filterType = this.value;
        const dateFilter = document.getElementById('dateFilter');
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');
        
        // 모든 필터 숨기기
        dateFilter.style.display = 'none';
        startDateFilter.style.display = 'none';
        endDateFilter.style.display = 'none';
        
        // 선택된 필터 타입에 따라 표시
        if (filterType === 'date') {
            dateFilter.style.display = 'block';
            document.getElementById('filterDate').value = today;
        } else if (filterType === 'period') {
            startDateFilter.style.display = 'block';
            endDateFilter.style.display = 'block';
            document.getElementById('filterStartDate').value = today;
            document.getElementById('filterEndDate').value = today;
        }
    });
    
    // 업무 목록 불러오기
    loadTasks();
});

// 업무 시작
document.getElementById('taskForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const workDate = document.getElementById('workDate').value;
    const startTime = document.getElementById('startTime').value;
    const taskType = document.getElementById('taskType').value;
    const description = document.getElementById('description').value;
    
    if (!workDate || !startTime || !taskType) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
    }
    
    try {
        const response = await fetch('/api/tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                work_date: workDate,
                start_time: startTime,
                task_type: taskType,
                description: description,
                status: '진행중'
            })
        });
        
        if (response.ok) {
            document.getElementById('taskForm').reset();
            // 기본값 다시 설정 (한국 시간 기준)
            const today = getKoreanDateString();
            document.getElementById('workDate').value = today;
            const currentTime = getKoreanTimeString();
            document.getElementById('startTime').value = currentTime;
            
            loadTasks();
            alert('업무가 시작되었습니다.');
        } else {
            const error = await response.json();
            alert(cleanErrorMessage(error));
        }
    } catch (error) {
        alert(cleanErrorMessage(error));
    }
});

// 업무 완료 처리
document.getElementById('completeTaskForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const taskId = document.getElementById('completeTaskId').value;
    const endTime = document.getElementById('endTime').value;
    const completeDescription = document.getElementById('completeDescription').value;
    
    if (!endTime) {
        alert('종료 시간을 입력해주세요.');
        return;
    }
    
    try {
        const response = await fetch(`/api/tasks/${taskId}/complete`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                end_time: endTime,
                complete_description: completeDescription
            })
        });
        
        if (response.ok) {
            cancelComplete();
            loadTasks();
            alert('업무가 완료되었습니다.');
        } else {
            const error = await response.json();
            alert(cleanErrorMessage(error));
        }
    } catch (error) {
        alert(cleanErrorMessage(error));
    }
});

// 업무 목록 불러오기
async function loadTasks() {
    try {
        const filterType = document.getElementById('filterType').value;
        let url = '/api/tasks';
        let titleText = '완료된 업무 목록';
        
        // 필터 파라미터 추가
        if (filterType === 'date') {
            const filterDate = document.getElementById('filterDate').value;
            if (filterDate) {
                url += `?date=${filterDate}`;
                titleText = `${filterDate} 완료된 업무 목록`;
            }
        } else if (filterType === 'period') {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            if (startDate && endDate) {
                url += `?start_date=${startDate}&end_date=${endDate}`;
                titleText = `${startDate} ~ ${endDate} 완료된 업무 목록`;
            }
        } else {
            // 오늘 조회 (한국 시간 기준)
            const today = getKoreanDateString();
            titleText = '오늘 완료된 업무 목록';
        }
        
        // 제목 업데이트
        document.getElementById('completedTasksTitle').textContent = titleText.replace('완료된 업무 목록', '');
        
        const response = await fetch(url);
        const tasks = await response.json();
        
        // 현재 진행 중인 업무
        const currentTasks = tasks.filter(task => task.status === '진행중');
        const currentTasksContainer = document.getElementById('currentTasks');
        document.getElementById('currentTasksCount').textContent = currentTasks.length;
        
        if (currentTasks.length === 0) {
            currentTasksContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-clock"></i>
                    <p>현재 진행 중인 업무가 없습니다.</p>
                </div>
            `;
        } else {
            let currentTasksHTML = '';
            currentTasks.forEach(task => {
                currentTasksHTML += `
                    <div class="task-card current">
                        <div class="task-card-header">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="task-type-badge ${task.task_type}">${task.task_type}</span>
                                    <span class="task-status-badge progress">진행중</span>
                                </div>
                                <small class="text-muted">${task.work_date}</small>
                            </div>
                        </div>
                        <div class="task-card-body">
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            <div class="task-info">
                                <div class="task-info-item">
                                    <i class="fas fa-play"></i>
                                    <span>시작: ${task.start_time}</span>
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="btn btn-outline-primary" onclick="editTask(${task.id})">
                                    <i class="fas fa-edit me-1"></i>수정
                                </button>
                                <button class="btn btn-success" onclick="showCompleteForm(${task.id})">
                                    <i class="fas fa-check me-1"></i>완료
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            currentTasksContainer.innerHTML = currentTasksHTML;
        }
        
        // 완료된 업무
        const completedTasks = tasks.filter(task => task.status === '완료');
        const completedTasksContainer = document.getElementById('completedTasksContainer');
        document.getElementById('completedTasksCount').textContent = completedTasks.length;
        
        if (completedTasks.length === 0) {
            completedTasksContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <p>완료된 업무가 없습니다.</p>
                </div>
            `;
        } else {
            let completedTasksHTML = '';
            completedTasks.forEach(task => {
                const duration = calculateDuration(task.start_time, task.end_time);
                completedTasksHTML += `
                    <div class="task-card completed">
                        <div class="task-card-header">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="task-type-badge ${task.task_type}">${task.task_type}</span>
                                    <span class="task-status-badge completed">완료</span>
                                </div>
                                <small class="text-muted">${task.work_date}</small>
                            </div>
                        </div>
                        <div class="task-card-body">
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            ${task.complete_description ? `<div class="task-description" style="background: #e8f5e8; border-left-color: #198754;">완료 내용: ${task.complete_description}</div>` : ''}
                            <div class="task-info">
                                <div class="task-info-item">
                                    <i class="fas fa-play"></i>
                                    <span>시작: ${task.start_time}</span>
                                </div>
                                <div class="task-info-item">
                                    <i class="fas fa-stop"></i>
                                    <span>종료: ${task.end_time || 'N/A'}</span>
                                </div>
                                ${duration ? `<div class="task-info-item">
                                    <i class="fas fa-clock"></i>
                                    <span>소요시간: ${duration}</span>
                                </div>` : ''}
                            </div>
                            <div class="task-actions">
                                <button class="btn btn-outline-primary" onclick="editCompletedTask(${task.id})">
                                    <i class="fas fa-edit me-1"></i>수정
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            completedTasksContainer.innerHTML = completedTasksHTML;
        }
    } catch (error) {
        console.error('업무 목록 불러오기 실패:', error);
    }
}

// 완료 폼 표시
function showCompleteForm(taskId) {
    document.getElementById('completeTaskId').value = taskId;
    
    // 현재 시간을 기본값으로 설정 (한국 시간 기준)
    const currentTime = getKoreanTimeString();
    document.getElementById('endTime').value = currentTime;
    
    document.getElementById('completeTaskCard').style.display = 'block';
    document.getElementById('completeTaskCard').scrollIntoView({ behavior: 'smooth' });
}

// 완료 폼 취소
function cancelComplete() {
    document.getElementById('completeTaskCard').style.display = 'none';
    document.getElementById('completeTaskForm').reset();
}

// 업무 수정 (모달)
async function editTask(taskId) {
    try {
        const response = await fetch(`/api/tasks/${taskId}`);
        if (response.ok) {
            const task = await response.json();
            
            // 모달 폼에 데이터 채우기
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editWorkDate').value = task.work_date;
            document.getElementById('editStartTime').value = task.start_time;
            document.getElementById('editEndTime').value = task.end_time || '';
            document.getElementById('editTaskType').value = task.task_type;
            document.getElementById('editDescription').value = task.description || '';
            document.getElementById('editCompleteDescription').value = task.complete_description || '';
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            modal.show();
        } else {
            alert(cleanErrorMessage('업무 정보를 불러오는데 실패했습니다.'));
        }
    } catch (error) {
        alert(cleanErrorMessage(error));
    }
}

// 완료된 업무 수정 (모달)
async function editCompletedTask(taskId) {
    try {
        const response = await fetch(`/api/tasks/${taskId}`);
        if (response.ok) {
            const task = await response.json();
            
            // 모달 폼에 데이터 채우기
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editWorkDate').value = task.work_date;
            document.getElementById('editStartTime').value = task.start_time;
            document.getElementById('editEndTime').value = task.end_time || '';
            document.getElementById('editTaskType').value = task.task_type;
            document.getElementById('editDescription').value = task.description || '';
            document.getElementById('editCompleteDescription').value = task.complete_description || '';
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            modal.show();
        } else {
            alert(cleanErrorMessage('업무 정보를 불러오는데 실패했습니다.'));
        }
    } catch (error) {
        alert(cleanErrorMessage(error));
    }
}

// 업무 수정 저장
async function saveTaskEdit() {
    const taskId = document.getElementById('editTaskId').value;
    const workDate = document.getElementById('editWorkDate').value;
    const startTime = document.getElementById('editStartTime').value;
    const endTime = document.getElementById('editEndTime').value;
    const taskType = document.getElementById('editTaskType').value;
    const description = document.getElementById('editDescription').value;
    const completeDescription = document.getElementById('editCompleteDescription').value;
    
    if (!workDate || !startTime || !taskType) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
    }
    
    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                work_date: workDate,
                start_time: startTime,
                end_time: endTime,
                task_type: taskType,
                description: description,
                complete_description: completeDescription
            })
        });
        
        if (response.ok) {
            // 모달 닫기
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
            modal.hide();
            
            loadTasks();
            alert('업무가 수정되었습니다.');
        } else {
            const error = await response.json();
            alert(cleanErrorMessage(error));
        }
    } catch (error) {
        alert(cleanErrorMessage(error));
    }
}

// 업무 삭제
async function deleteTask(taskId) {
    // 삭제할 업무 ID 저장
    window.deleteTaskId = taskId;
    
    // 삭제 확인 모달 표시
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
}

// 모달에서 업무 삭제
async function deleteTaskFromModal() {
    const taskId = document.getElementById('editTaskId').value;
    
    // 삭제할 업무 ID 저장
    window.deleteTaskId = taskId;
    
    // 수정 모달 닫기
    const editModal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
    editModal.hide();
    
    // 삭제 확인 모달 표시
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
}

// 삭제 확인 후 실제 삭제 실행
async function confirmDeleteTask() {
    const taskId = window.deleteTaskId;
    
    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // 삭제 확인 모달 닫기
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
            deleteModal.hide();
            
            loadTasks();
            
            // 성공 메시지 표시
            showSuccessMessage('업무가 성공적으로 삭제되었습니다.');
        } else {
            const error = await response.json();
            showErrorMessage(cleanErrorMessage(error));
        }
    } catch (error) {
        showErrorMessage(cleanErrorMessage(error));
    }
}

// 성공 메시지 표시
function showSuccessMessage(message) {
    // Bootstrap toast 또는 alert 사용
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // 3초 후 자동 제거
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// 에러 메시지 표시
function showErrorMessage(message) {
    // Bootstrap toast 또는 alert 사용
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-circle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // 5초 후 자동 제거
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// 소요 시간 계산
function calculateDuration(startTime, endTime) {
    const [startHour, startMin] = startTime.split(':').map(Number);
    const [endHour, endMin] = endTime.split(':').map(Number);
    
    let diffHour = endHour - startHour;
    let diffMin = endMin - startMin;
    
    if (diffMin < 0) {
        diffHour -= 1;
        diffMin += 60;
    }
    
    if (diffHour < 0) {
        diffHour += 24; // 하루를 넘어간 경우
    }
    
    if (diffHour > 0) {
        return `${diffHour}시간 ${diffMin}분`;
    } else {
        return `${diffMin}분`;
    }
}
</script>
{% endblock %} 