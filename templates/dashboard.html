{% extends "base.html" %}

{% block title %}업무 대시보드 - 다이소 안성센터{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>안녕하세요, {{ user.username }}님!</h2>
                <p class="text-muted">소속: {{ user.department_name if user.department_name else '미지정' }}</p>
            </div>
            <div>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">로그아웃</a>
            </div>
        </div>
        
        <!-- 새 업무 시작 섹션 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">새 업무 시작</h5>
            </div>
            <div class="card-body">
                <form id="taskForm">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="workDate" class="form-label">업무 날짜</label>
                                <input type="date" class="form-control date-input" id="workDate" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="startTime" class="form-label">시작 시간</label>
                                <input type="time" class="form-control time-input" id="startTime" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="taskType" class="form-label">업무 유형</label>
                                <select class="form-select task-type-select" id="taskType" required>
                                    <option value="">업무 유형 선택</option>
                                    <option value="인출">인출</option>
                                    <option value="보충">보충</option>
                                    <option value="입고지원">입고지원</option>
                                    <option value="미출대응">미출대응</option>
                                    <option value="단내리기">단내리기</option>
                                    <option value="이고">이고</option>
                                    <option value="과출">과출</option>
                                    <option value="파손">파손</option>
                                    <option value="기타">기타</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="description" class="form-label">업무 내용</label>
                                <input type="text" class="form-control" id="description" placeholder="업무 내용을 입력하세요">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">업무 시작</button>
                </form>
            </div>
        </div>
        
        <!-- 현재 진행 중인 업무 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">현재 진행 중인 업무</h5>
            </div>
            <div class="card-body">
                <div id="currentTasks">
                    <!-- 현재 업무가 여기에 동적으로 로드됩니다 -->
                </div>
            </div>
        </div>
        
        <!-- 업무 완료 처리 -->
        <div class="card mb-4 complete-form" id="completeTaskCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">업무 완료</h5>
            </div>
            <div class="card-body">
                <form id="completeTaskForm">
                    <input type="hidden" id="completeTaskId">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="endTime" class="form-label">종료 시간</label>
                                <input type="time" class="form-control time-input" id="endTime" required>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="completeDescription" class="form-label">완료 내용</label>
                                <input type="text" class="form-control" id="completeDescription" placeholder="완료된 업무 내용을 입력하세요">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">업무 완료</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelComplete()">취소</button>
                </form>
            </div>
        </div>
        
        <!-- 조회 필터 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">업무 조회</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="filterType" class="form-label">조회 유형</label>
                            <select class="form-select" id="filterType">
                                <option value="today">오늘</option>
                                <option value="date">특정 날짜</option>
                                <option value="period">기간</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3" id="dateFilter" style="display: none;">
                        <div class="mb-3">
                            <label for="filterDate" class="form-label">날짜 선택</label>
                            <input type="date" class="form-control" id="filterDate">
                        </div>
                    </div>
                    <div class="col-md-3" id="startDateFilter" style="display: none;">
                        <div class="mb-3">
                            <label for="filterStartDate" class="form-label">시작 날짜</label>
                            <input type="date" class="form-control" id="filterStartDate">
                        </div>
                    </div>
                    <div class="col-md-3" id="endDateFilter" style="display: none;">
                        <div class="mb-3">
                            <label for="filterEndDate" class="form-label">종료 날짜</label>
                            <input type="date" class="form-control" id="filterEndDate">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-primary d-block" onclick="loadTasks()">조회</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 완료된 업무 목록 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0" id="completedTasksTitle">완료된 업무 목록</h5>
            </div>
            <div class="card-body">
                <div id="completedTasksContainer">
                    <!-- 완료된 업무가 여기에 동적으로 로드됩니다 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 업무 수정 모달 -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">업무 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editWorkDate" class="form-label">업무 날짜</label>
                                <input type="date" class="form-control date-input" id="editWorkDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTaskType" class="form-label">업무 유형</label>
                                <select class="form-select task-type-select" id="editTaskType" required>
                                    <option value="">업무 유형 선택</option>
                                    <option value="인출">인출</option>
                                    <option value="보충">보충</option>
                                    <option value="입고지원">입고지원</option>
                                    <option value="미출대응">미출대응</option>
                                    <option value="단내리기">단내리기</option>
                                    <option value="이고">이고</option>
                                    <option value="과출">과출</option>
                                    <option value="파손">파손</option>
                                    <option value="기타">기타</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStartTime" class="form-label">시작 시간</label>
                                <input type="time" class="form-control time-input" id="editStartTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editEndTime" class="form-label">종료 시간</label>
                                <input type="time" class="form-control time-input" id="editEndTime">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">업무 내용</label>
                        <input type="text" class="form-control" id="editDescription" placeholder="업무 내용을 입력하세요">
                    </div>
                    <div class="mb-3">
                        <label for="editCompleteDescription" class="form-label">완료 내용</label>
                        <input type="text" class="form-control" id="editCompleteDescription" placeholder="완료된 업무 내용을 입력하세요">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveTaskEdit()">수정</button>
            </div>
        </div>
    </div>
</div>

<script>
// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 오늘 날짜를 기본값으로 설정
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('workDate').value = today;
    
    // 현재 시간을 기본값으로 설정 (24시간 형식)
    const now = new Date();
    const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
    document.getElementById('startTime').value = currentTime;
    
    // 조회 필터 이벤트 리스너
    document.getElementById('filterType').addEventListener('change', function() {
        const filterType = this.value;
        const dateFilter = document.getElementById('dateFilter');
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');
        
        // 모든 필터 숨기기
        dateFilter.style.display = 'none';
        startDateFilter.style.display = 'none';
        endDateFilter.style.display = 'none';
        
        // 선택된 필터 타입에 따라 표시
        if (filterType === 'date') {
            dateFilter.style.display = 'block';
            document.getElementById('filterDate').value = today;
        } else if (filterType === 'period') {
            startDateFilter.style.display = 'block';
            endDateFilter.style.display = 'block';
            document.getElementById('filterStartDate').value = today;
            document.getElementById('filterEndDate').value = today;
        }
    });
    
    // 업무 목록 불러오기
    loadTasks();
});

// 업무 시작
document.getElementById('taskForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const workDate = document.getElementById('workDate').value;
    const startTime = document.getElementById('startTime').value;
    const taskType = document.getElementById('taskType').value;
    const description = document.getElementById('description').value;
    
    if (!workDate || !startTime || !taskType) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
    }
    
    try {
        const response = await fetch('/api/tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                work_date: workDate,
                start_time: startTime,
                task_type: taskType,
                description: description,
                status: '진행중'
            })
        });
        
        if (response.ok) {
            document.getElementById('taskForm').reset();
            // 기본값 다시 설정
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('workDate').value = today;
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            document.getElementById('startTime').value = currentTime;
            
            loadTasks();
            alert('업무가 시작되었습니다.');
        } else {
            const error = await response.json();
            alert(error.error || '업무 시작에 실패했습니다.');
        }
    } catch (error) {
        alert('업무 시작 중 오류가 발생했습니다.');
    }
});

// 업무 완료 처리
document.getElementById('completeTaskForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const taskId = document.getElementById('completeTaskId').value;
    const endTime = document.getElementById('endTime').value;
    const completeDescription = document.getElementById('completeDescription').value;
    
    if (!endTime) {
        alert('종료 시간을 입력해주세요.');
        return;
    }
    
    try {
        const response = await fetch(`/api/tasks/${taskId}/complete`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                end_time: endTime,
                complete_description: completeDescription
            })
        });
        
        if (response.ok) {
            cancelComplete();
            loadTasks();
            alert('업무가 완료되었습니다.');
        } else {
            const error = await response.json();
            alert(error.error || '업무 완료 처리에 실패했습니다.');
        }
    } catch (error) {
        alert('업무 완료 처리 중 오류가 발생했습니다.');
    }
});

// 업무 목록 불러오기
async function loadTasks() {
    try {
        const filterType = document.getElementById('filterType').value;
        let url = '/api/tasks';
        let titleText = '완료된 업무 목록';
        
        // 필터 파라미터 추가
        if (filterType === 'date') {
            const filterDate = document.getElementById('filterDate').value;
            if (filterDate) {
                url += `?date=${filterDate}`;
                titleText = `${filterDate} 완료된 업무 목록`;
            }
        } else if (filterType === 'period') {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            if (startDate && endDate) {
                url += `?start_date=${startDate}&end_date=${endDate}`;
                titleText = `${startDate} ~ ${endDate} 완료된 업무 목록`;
            }
        } else {
            // 오늘 조회
            const today = new Date().toISOString().split('T')[0];
            titleText = '오늘 완료된 업무 목록';
        }
        
        // 제목 업데이트
        document.getElementById('completedTasksTitle').textContent = titleText;
        
        const response = await fetch(url);
        const tasks = await response.json();
        
        // 현재 진행 중인 업무
        const currentTasks = tasks.filter(task => task.status === '진행중');
        const currentTasksDiv = document.getElementById('currentTasks');
        
        if (currentTasks.length === 0) {
            currentTasksDiv.innerHTML = '<div class="empty-state"><i class="fas fa-clock"></i><p>현재 진행 중인 업무가 없습니다.</p></div>';
        } else {
            let currentTasksHTML = '';
            currentTasks.forEach(task => {
                const startTime = task.start_time;
                currentTasksHTML += `
                    <div class="card mb-2 current-task-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">${task.task_type} <span class="badge status-badge progress">진행중</span></h6>
                                    <p class="card-text">${task.description || '내용 없음'}</p>
                                    <small class="text-muted">날짜: ${task.work_date} | 시작 시간: ${startTime}</small>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editCompletedTask(${task.id})">수정</button>
                                    <button class="btn btn-success" onclick="showCompleteForm(${task.id})">완료</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            currentTasksDiv.innerHTML = currentTasksHTML;
        }
        
        // 완료된 업무
        const completedTasks = tasks.filter(task => task.status === '완료');
        const completedTasksContainer = document.getElementById('completedTasksContainer');
        
        if (completedTasks.length === 0) {
            completedTasksContainer.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>완료된 업무가 없습니다.</p></div>';
        } else {
            let completedTasksHTML = '';
            completedTasks.forEach(task => {
                const duration = calculateDuration(task.start_time, task.end_time);
                
                // 오늘 조회 시에는 날짜 정보 숨기기
                const dateInfo = filterType === 'today' ? '' : `<small class="text-muted">날짜: ${task.work_date}</small>`;
                
                completedTasksHTML += `
                    <div class="card mb-2 completed-task-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <h6 class="card-title mb-0 me-3">${task.task_type}</h6>
                                        <span class="badge bg-success">완료</span>
                                    </div>
                                    <p class="card-text mb-2">${task.description || '내용 없음'}</p>
                                    <div class="task-time-info">
                                        ${dateInfo}
                                        <small class="text-muted d-block">시작: ${task.start_time} | 종료: ${task.end_time || 'N/A'}</small>
                                        ${task.complete_description ? `<small class="text-muted d-block">완료 내용: ${task.complete_description}</small>` : ''}
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editCompletedTask(${task.id})">수정</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            completedTasksContainer.innerHTML = completedTasksHTML;
        }
    } catch (error) {
        console.error('업무 목록 불러오기 실패:', error);
    }
}

// 완료 폼 표시
function showCompleteForm(taskId) {
    document.getElementById('completeTaskId').value = taskId;
    
    // 현재 시간을 기본값으로 설정
    const now = new Date();
    const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
    document.getElementById('endTime').value = currentTime;
    
    document.getElementById('completeTaskCard').style.display = 'block';
    document.getElementById('completeTaskCard').scrollIntoView({ behavior: 'smooth' });
}

// 완료 폼 취소
function cancelComplete() {
    document.getElementById('completeTaskCard').style.display = 'none';
    document.getElementById('completeTaskForm').reset();
}

// 업무 수정 (모달)
async function editTask(taskId) {
    try {
        const response = await fetch(`/api/tasks/${taskId}`);
        if (response.ok) {
            const task = await response.json();
            
            // 모달 폼에 데이터 채우기
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editWorkDate').value = task.work_date;
            document.getElementById('editStartTime').value = task.start_time;
            document.getElementById('editEndTime').value = task.end_time || '';
            document.getElementById('editTaskType').value = task.task_type;
            document.getElementById('editDescription').value = task.description || '';
            document.getElementById('editCompleteDescription').value = task.complete_description || '';
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            modal.show();
        } else {
            alert('업무 정보를 불러오는데 실패했습니다.');
        }
    } catch (error) {
        alert('업무 정보를 불러오는 중 오류가 발생했습니다.');
    }
}

// 완료된 업무 수정 (모달)
async function editCompletedTask(taskId) {
    try {
        const response = await fetch(`/api/tasks/${taskId}`);
        if (response.ok) {
            const task = await response.json();
            
            // 모달 폼에 데이터 채우기
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editWorkDate').value = task.work_date;
            document.getElementById('editStartTime').value = task.start_time;
            document.getElementById('editEndTime').value = task.end_time || '';
            document.getElementById('editTaskType').value = task.task_type;
            document.getElementById('editDescription').value = task.description || '';
            document.getElementById('editCompleteDescription').value = task.complete_description || '';
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            modal.show();
        } else {
            alert('업무 정보를 불러오는데 실패했습니다.');
        }
    } catch (error) {
        alert('업무 정보를 불러오는 중 오류가 발생했습니다.');
    }
}

// 업무 수정 저장
async function saveTaskEdit() {
    const taskId = document.getElementById('editTaskId').value;
    const workDate = document.getElementById('editWorkDate').value;
    const startTime = document.getElementById('editStartTime').value;
    const endTime = document.getElementById('editEndTime').value;
    const taskType = document.getElementById('editTaskType').value;
    const description = document.getElementById('editDescription').value;
    const completeDescription = document.getElementById('editCompleteDescription').value;
    
    if (!workDate || !startTime || !taskType) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
    }
    
    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                work_date: workDate,
                start_time: startTime,
                end_time: endTime,
                task_type: taskType,
                description: description,
                complete_description: completeDescription
            })
        });
        
        if (response.ok) {
            // 모달 닫기
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
            modal.hide();
            
            loadTasks();
            alert('업무가 수정되었습니다.');
        } else {
            const error = await response.json();
            alert(error.error || '업무 수정에 실패했습니다.');
        }
    } catch (error) {
        alert('업무 수정 중 오류가 발생했습니다.');
    }
}

// 업무 삭제
async function deleteTask(taskId) {
    if (!confirm('정말로 이 업무를 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadTasks();
            alert('업무가 삭제되었습니다.');
        } else {
            const error = await response.json();
            alert(error.error || '업무 삭제에 실패했습니다.');
        }
    } catch (error) {
        alert('업무 삭제 중 오류가 발생했습니다.');
    }
}

// 소요 시간 계산
function calculateDuration(startTime, endTime) {
    const [startHour, startMin] = startTime.split(':').map(Number);
    const [endHour, endMin] = endTime.split(':').map(Number);
    
    let diffHour = endHour - startHour;
    let diffMin = endMin - startMin;
    
    if (diffMin < 0) {
        diffHour -= 1;
        diffMin += 60;
    }
    
    if (diffHour < 0) {
        diffHour += 24; // 하루를 넘어간 경우
    }
    
    if (diffHour > 0) {
        return `${diffHour}시간 ${diffMin}분`;
    } else {
        return `${diffMin}분`;
    }
}
</script>
{% endblock %} 