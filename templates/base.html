<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}다이소 안성센터{% endblock %}</title>
    
    <!-- PWA 메타 태그 -->
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WorkTracker">
    <meta name="msapplication-TileColor" content="#0d6efd">
    <meta name="msapplication-config" content="/static/browserconfig.xml">
    
    <!-- PWA 매니페스트 -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <!-- 아이콘 -->
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/icon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='icons/icon-16x16.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-152x152.png') }}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">다이소 안성센터</a>
        </div>
    </nav>

    <div class="container mt-4">
        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- PWA 서비스 워커 등록 -->
    <script>
        // PWA 설치 상태 확인
        let deferredPrompt;
        let installButton = null;
        let isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // DOM이 로드된 후 설치 버튼 찾기
        function findInstallButton() {
            if (!installButton) {
                installButton = document.getElementById('installButton');
                if (installButton) {
                    console.log('설치 버튼 요소 발견');
                    updateInstallButton();
                }
            }
            return installButton;
        }
        
        // 서비스 워커 등록
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('SW 등록 성공:', registration.scope);
                        checkInstallability();
                    })
                    .catch(error => {
                        console.log('SW 등록 실패:', error);
                        checkInstallability();
                    });
            });
        } else {
            console.log('서비스 워커를 지원하지 않는 브라우저입니다.');
            checkInstallability();
        }
        
        // PWA 설치 가능 여부 확인
        function checkInstallability() {
            // 매니페스트 확인
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                console.log('PWA 기능 지원됨');
            }
            
            // 설치 버튼이 있는지 확인
            findInstallButton();
        }
        
        // PWA 설치 가능 여부 체크
        function canInstallPWA() {
            return 'serviceWorker' in navigator && 
                   'PushManager' in window && 
                   deferredPrompt !== null;
        }
        
        // 설치 버튼 업데이트
        function updateInstallButton() {
            const button = findInstallButton();
            if (!button) return;
            
            // 먼저 버튼을 표시
            button.style.display = 'inline-block';
            
            // 모바일 기기인지 확인
            let isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (canInstallPWA()) {
                // 실제 PWA 설치 가능
                button.innerHTML = '<i class="fas fa-download"></i> 앱 설치';
                button.className = 'btn btn-outline-success w-100 mb-2';
                button.onclick = installApp;
                console.log('실제 PWA 설치 버튼으로 설정');
            } else if (isMobile) {
                // 모바일에서는 설치 안내로 이동
                button.innerHTML = '<i class="fas fa-download"></i> 📱 앱 설치 안내';
                button.className = 'btn btn-outline-info w-100 mb-2';
                button.onclick = function() {
                    window.location.href = '/install';
                };
                console.log('모바일 설치 안내 버튼으로 설정');
            } else {
                // 데스크톱에서는 설치 안내로 이동
                button.innerHTML = '<i class="fas fa-download"></i> 📱 앱 설치 안내';
                button.className = 'btn btn-outline-info w-100 mb-2';
                button.onclick = function() {
                    window.location.href = '/install';
                };
                console.log('데스크톱 설치 안내 버튼으로 설정');
            }
        }
        
        // PWA 설치 프롬프트 이벤트
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('beforeinstallprompt 이벤트 발생');
            e.preventDefault();
            deferredPrompt = e;
            
            // 설치 버튼 표시 및 설정
            const button = findInstallButton();
            if (button) {
                button.style.display = 'inline-block';
                button.innerHTML = '<i class="fas fa-download"></i> 앱 설치';
                button.className = 'btn btn-outline-success w-100 mb-2';
                button.onclick = installApp;
                console.log('실제 PWA 설치 버튼으로 설정됨');
            } else {
                console.log('설치 버튼 요소가 없음');
            }
        });
        
        // 앱 설치 함수
        function installApp() {
            if (deferredPrompt) {
                // 실제 PWA 설치 프롬프트 표시
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('사용자가 앱 설치를 수락했습니다');
                        const button = findInstallButton();
                        if (button) {
                            button.style.display = 'none';
                        }
                    } else {
                        console.log('사용자가 앱 설치를 거부했습니다');
                    }
                    deferredPrompt = null;
                });
            } else {
                // 설치 프롬프트가 없으면 설치 안내 페이지로 이동
                console.log('설치 프롬프트가 없어서 설치 안내 페이지로 이동');
                window.location.href = '/install';
            }
        }
        
        // 앱이 이미 설치되었는지 확인
        window.addEventListener('appinstalled', (evt) => {
            console.log('앱이 설치되었습니다');
            const button = findInstallButton();
            if (button) {
                button.style.display = 'none';
            }
        });
        
        // 페이지 로드 시 설치 버튼 상태 확인
        window.addEventListener('load', () => {
            if (isMobile) {
                console.log('모바일 기기 감지됨');
                
                // 모바일 설치 안내 배너 표시
                const mobileBanner = document.getElementById('mobileInstallBanner');
                if (mobileBanner) {
                    mobileBanner.style.display = 'block';
                }
            }
            
            // 설치 버튼 초기 설정
            const button = findInstallButton();
            if (button) {
                // beforeinstallprompt 이벤트가 발생하지 않았다면 설치 안내로 설정
                if (!deferredPrompt) {
                    let isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    if (isMobile) {
                        button.innerHTML = '<i class="fas fa-download"></i> 📱 앱 설치 안내';
                        button.className = 'btn btn-outline-info w-100 mb-2';
                        button.onclick = function() {
                            window.location.href = '/install';
                        };
                    } else {
                        button.innerHTML = '<i class="fas fa-download"></i> 📱 앱 설치 안내';
                        button.className = 'btn btn-outline-info w-100 mb-2';
                        button.onclick = function() {
                            window.location.href = '/install';
                        };
                    }
                }
            }
        });
    </script>
</body>
</html> 