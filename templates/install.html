{% extends "base.html" %}

{% block title %}ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” - ë‹¤ì´ì†Œ ì•ˆì„±ì„¼í„°{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header text-center">
                <h4 class="mb-0">ğŸ”§ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”</h4>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="app-icon mb-3">
                        <i class="fas fa-database fa-3x text-primary"></i>
                    </div>
                    <h5>WorkTracker ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •</h5>
                    <p class="text-muted">í•œêµ­ì‹œê°„ëŒ€(KST) ì ìš© ë° ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ë³µì›</p>
                </div>

                <div class="alert alert-warning">
                    <h6>âš ï¸ ì£¼ì˜ì‚¬í•­</h6>
                    <ul class="mb-0">
                        <li>ì´ ì‘ì—…ì€ ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤</li>
                        <li>ì´ˆê¸°í™” í›„ì—ëŠ” ê¸°ë³¸ ê´€ë¦¬ì ê³„ì •ë§Œ ìƒì„±ë©ë‹ˆë‹¤</li>
                        <li>í•œêµ­ì‹œê°„ëŒ€(KST) ì„¤ì •ì´ ì ìš©ë©ë‹ˆë‹¤</li>
                    </ul>
                </div>

                <div class="database-info mb-4">
                    <h6>ğŸ“Š ì´ˆê¸°í™” ë‚´ìš©</h6>
                    <ul class="list-unstyled">
                        <li>âœ… ëª¨ë“  í…Œì´ë¸”, í•¨ìˆ˜, íŠ¸ë¦¬ê±° ì‚­ì œ</li>
                        <li>âœ… í•œêµ­ì‹œê°„ëŒ€(KST) ì ìš©ëœ ìƒˆ êµ¬ì¡° ìƒì„±</li>
                        <li>âœ… ê¸°ë³¸ ì†Œì† ë°ì´í„° ìƒì„± (Bë™ë³´ì¶©, Aì§€ìƒë³´ì¶©, Aì§€í•˜ë³´ì¶©)</li>
                        <li>âœ… ê´€ë¦¬ì ê³„ì • ìƒì„± (admin / 0000)</li>
                        <li>âœ… Row Level Security (RLS) ì„¤ì •</li>
                        <li>âœ… ì¸ë±ìŠ¤ ë° ë·° ìƒì„±</li>
                    </ul>
                </div>

                <div class="text-center">
                    <button id="initDbBtn" class="btn btn-danger btn-lg" onclick="initializeDatabase()">
                        <i class="fas fa-database"></i> ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì‹¤í–‰
                    </button>
                </div>

                <div id="initProgress" class="mt-4" style="display: none;">
                    <div class="progress mb-3">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="progressText" class="text-center text-muted">ì´ˆê¸°í™” ì§„í–‰ ì¤‘...</div>
                </div>

                <div id="initResult" class="mt-4" style="display: none;">
                    <div id="resultMessage" class="alert"></div>
                </div>

                <div class="text-center mt-4">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function initializeDatabase() {
    const btn = document.getElementById('initDbBtn');
    const progress = document.getElementById('initProgress');
    const result = document.getElementById('initResult');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const resultMessage = document.getElementById('resultMessage');

    // ë²„íŠ¼ ë¹„í™œì„±í™”
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì´ˆê¸°í™” ì¤‘...';
    
    // ì§„í–‰ë¥  í‘œì‹œ
    progress.style.display = 'block';
    result.style.display = 'none';
    
    try {
        // SQL íŒŒì¼ ì½ê¸°
        progressBar.style.width = '20%';
        progressText.textContent = 'SQL íŒŒì¼ ë¡œë”© ì¤‘...';
        
        const response = await fetch('/api/init-database', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        progressBar.style.width = '100%';
        progressText.textContent = 'ì™„ë£Œ!';

        if (response.ok) {
            const data = await response.json();
            resultMessage.className = 'alert alert-success';
            resultMessage.innerHTML = `
                <h6>âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì„±ê³µ!</h6>
                <p>í•œêµ­ì‹œê°„ëŒ€(KST) ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <ul class="mb-0">
                    <li>ê´€ë¦¬ì ê³„ì •: admin / 0000</li>
                    <li>ê¸°ë³¸ ì†Œì†: Bë™ë³´ì¶©, Aì§€ìƒë³´ì¶©, Aì§€í•˜ë³´ì¶©</li>
                    <li>ëª¨ë“  í…Œì´ë¸”ê³¼ ì •ì±…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤</li>
                </ul>
            `;
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        resultMessage.className = 'alert alert-danger';
        resultMessage.innerHTML = `
            <h6>âŒ ì´ˆê¸°í™” ì‹¤íŒ¨</h6>
            <p>ì˜¤ë¥˜: ${error.message}</p>
            <p>ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
        `;
    } finally {
        result.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-database"></i> ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì‹¤í–‰';
    }
}
</script>

<style>
.app-icon i {
    border: 3px solid #0d6efd;
    border-radius: 50%;
    padding: 1rem;
    background-color: #f8f9fa;
}

.database-info ul li {
    padding: 0.5rem 0;
    border-bottom: 1px solid #e9ecef;
}

.database-info ul li:last-child {
    border-bottom: none;
}

.progress {
    height: 25px;
}
</style>
{% endblock %} 